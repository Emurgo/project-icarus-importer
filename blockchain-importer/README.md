# `cardano-sl-blockchain-importer`

Package based on the `cardano-sl-explorer` (in how it's hooked to the Cardano node), which keeps a postgres db up-to-date with it's rocks db, saving in it:
- The current UTxO.
- The best block number.
- The tx history (including successful, failed and pending txs).

## Installation

### Requirements

Installation of `nix` is needed.

```bash
curl https://nixos.org/nix/install | sh
source ~/.nix-profile/etc/profile.d/nix.sh
```

Make sure that `nix` is set to `true` within `~/.stack/config.yaml`.

```
nix:
  enable: true
```

## Generate documentation

Generated documentation for BlockchainImporter Web API can be obtained (as `blockchain-importer-web-api-swagger.json`) by running:
```bash
stack exec cardano-importer-swagger
```

## Run mock server

```bash
stack exec cardano-blockchain-importer-mock
```

## Run it

**Pre-requesites**: `sudo apt-get install liblzma-dev libpq-dev`

Run it from project root.

### Dev version

- run `./scripts/build/cardano-sl.sh blockchain-importer`
- Using `stack exec` to use the importer, such as in:
```bash
stack exec -- cardano-blockchain-importer --topology "/tmp/topology-staging.yaml" --log-config "blockchain-importer/log-config.yaml" --logs-prefix "logs" --db-path "db-importer" --keyfile "secret-staging.key" --configuration-file "lib/configuration.yaml" --configuration-key mainnet_dryrun_full --postgres-name "stagingpgdb" --postgres-password "mysecretpassword" --postgres-host "localhost"
```

### Prod version (connects BlockchainImporter to `staging` or `mainnet`)

- Run `/scripts/clean/db.sh` to do a clean synchronization, so that BlockchainImporter will sync and download blockchain from start.
- Create an empty Postgres DB with the tables and indexes from `scripts/generate/blockImporterTables-beta.sql`.
- Connect to cluster as described in  `docs/how-to/connect-to-cluster.md` **FIXME: Add usage of nix for building, currently doesn't work**

## Recovery mode

In case of a potential crash of the importer, or the server running it, the importer Rocks db could reach a corrupted state (with `DBMalformed error` for example). To address this problem:
- Have a back-up Cardano node syncing (in the same chain)
- When the crash happens, stop the Cardano node and start-up the importer on recovery mode with the same Postgres db configured, but using the Rocks db of the Cardano node.
**Note**: Recovery mode can be enabled with the flag `--recovery-mode`.


# `cardano-sl-importer-db-consistency`

Checks the consistency of the postgres db generated by the `cardano-sl-blockchain-importer` internally (with it's rocks db) and externally (with the db of a Cardano node).

The following checks were carried out (and should be re-done periodically):
- Check the internal consistency of the staging and mainnet dbs (using `blockchain-importer/scripts/launch/internal-consistency.sh`).
- Check the internal consistency of the db upon restart (using `blockchain-importer/scripts/launch/internal-consistency.sh`).
- Check the consistency of an up-to-date db with the one of an up-to-date Cardano node (using `blockchain-importer/scripts/launch/external-consistency-from-blk.sh`).

The results and configurations used for the scripts can be seen in `blockchain-importer/scripts/launch/staging-test-results.txt` and `blockchain-importer/scripts/launch/mainnet-test-results.txt`.
